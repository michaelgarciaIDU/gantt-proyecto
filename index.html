<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Gantt Global</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
<style>
  html, body {
    margin: 0; padding: 0; width: 100%; height: 100%;
    display: flex; flex-direction: column;
  }
  :root { 
    --track: #f4f5f7; 
    --grid: #e6e8eb; 
    --bar: #5b8def; 
    --barDone:#7bd389; 
    --text:#222; 
    --today:#ff5a5f; 
  }
  body { 
    font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; 
    background: #fff; 
    color: var(--text);
  }
  .wrap { flex: 0 0 auto; padding: 10px; background: #fafbfc; border-bottom: 1px solid #ccc; z-index: 10; }
  .gantt { border: 1px solid #ddd; border-radius: 14px; overflow: hidden; box-shadow: 0 2px 10px rgba(0,0,0,.04); position: relative;}
  .header { display: grid; grid-template-columns: 240px 1fr; background: #fff; border-bottom:1px solid #eee; position: sticky; top: 0; z-index: 3; }
  .header .left, .body .left { padding: 10px 12px; background: #fff; border:1px solid #eee;}
  .scale { position: relative; height: 40px; }
  .scale .tick { position:absolute; top:0; bottom:0; width:1px; background: var(--grid);}
  .scale .label { position:absolute; top: 4px; font-size: 12px; color:#555; transform: translateX(-50%); white-space: nowrap;}
  .body { display: block; position: relative;}
  .row { display:grid; grid-template-columns: 240px 1fr; }
  .row .left { display:flex; align-items:center; gap:8px; border-bottom:1px solid #f0f0f0; }
  .row .right { position: relative; height: 40px; background: var(--track); border-bottom:1px solid #f0f0f0; }
  svg { display:block; width:100%; height:100%; }
  .bar rect { rx: 6; ry: 6; }
  .badge { font-size:11px; padding:2px 6px; border-radius:999px; background:#eef2ff; color:#3b5bcc; }
  .tooltip { position: fixed; pointer-events: none; background:#111; color:#fff; padding:8px 10px; font-size:12px; border-radius:8px; box-shadow:0 6px 20px rgba(0,0,0,.25); opacity:0; transition:opacity .08s ease; z-index: 10;}
  #gantt-container { flex: 1 1 auto; overflow-x: auto; overflow-y: auto;}
  #body .left { position: sticky; left: 0; background: #fff; z-index: 2; border-right: 1px solid #ddd; }
  .today-line {
    position: absolute;
    top: 0;
    bottom: 0;
    width: 4px;
    background: repeating-linear-gradient(
      45deg,
      var(--today),
      var(--today) 4px,
      transparent 4px,
      transparent 8px
    );
    z-index: 5;
    pointer-events: none;
  }
</style>
</head>
<body>
<div class="wrap">
  <label for="filtroID">Filtrar por ID:</label>
  <select id="filtroID"><option value="todos">Todos</option></select>
  <label for="filtroAct">Filtrar por Actividad:</label>
  <select id="filtroAct"><option value="todas">Todas</option></select>
  <label for="yearStart">Desde:</label>
  <select  id="yearStart"></select>
  <label for="yearEnd">Hasta:</label>
  <select id="yearEnd"></select>
  <div id="gantt-container">
    <div class="gantt" id="gantt">
      <div class="header">
        <div class="left"><strong>Tarea</strong></div>
        <div class="right"><div class="scale" id="scale"></div></div>
      </div>
      <div class="body" id="body"></div>
    </div>
  </div>
</div>

<div class="tooltip" id="tooltip"></div>

<script>
(() => {
  const sheetUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQEI_N__u5SB7mPNeRLDGTcDZby4bs7TX0egicNqjaxwfTLdbtAkq4ESR358oHkAkS0OUtiEwFNbQdJ/pub?gid=665489139&single=true&output=csv";
  let rawData = [];
  let globalMinDate, globalMaxDate;

  fetch(sheetUrl)
    .then(res => res.text())
    .then(csv => {
      rawData = Papa.parse(csv, { header: true }).data.filter(r => r.Inicio && r.Fin);
      document.getElementById("yearStart").value = 2025;
      // rango global
      globalMinDate = rawData.reduce((m,r)=> new Date(r.Inicio) < m ? new Date(r.Inicio) : m, new Date(rawData[0].Inicio));
      globalMaxDate = rawData.reduce((m,r)=> new Date(r.Fin) > m ? new Date(r.Fin) : m, new Date(rawData[0].Fin));

      llenarSelect(document.getElementById("filtroID"), [...new Set(rawData.map(r => r.ID_BD))], "todos");
      llenarSelect(document.getElementById("filtroAct"), [...new Set(rawData.map(r => r.Actividad))], "todas");
      aplicarFiltros();
      
      llenarAnios();
    });

  function llenarSelect(select, valores, opcionTodos) {
    select.innerHTML = "";
    let opt = document.createElement("option");
    opt.value = opcionTodos;
    opt.textContent = opcionTodos === "todos" ? "Todos" : "Todas";
    select.appendChild(opt);
    valores.forEach(v => {
      if (!v) return;
      let option = document.createElement("option");
      option.value = v;
      option.textContent = v;
      select.appendChild(option);
    });
    select.addEventListener("change", aplicarFiltros);
  }

  function llenarAnios() {
    
    const yearStartSel = document.getElementById("yearStart");
    const yearEndSel   = document.getElementById("yearEnd");

    const minYear = globalMinDate.getFullYear();
    const maxYear = globalMaxDate.getFullYear();

    for (let y = minYear; y <= maxYear; y++) {
      let opt1 = document.createElement("option");
      opt1.value = y; opt1.textContent = y;
      yearStartSel.appendChild(opt1);

      let opt2 = document.createElement("option");
      opt2.value = y; opt2.textContent = y;
      yearEndSel.appendChild(opt2);
    }

    if ([...yearStartSel.options].some(opt => opt.value === "2025")) {
      yearStartSel.value = "2025";
    } else {
      // Si 2025 no existe, dejar el Ãºltimo aÃ±o disponible
      yearStartSel.value = minYear;
      
    }
    yearEndSel.value   = maxYear;
    yearStartSel.addEventListener("change", aplicarFiltros);
    yearEndSel.addEventListener("change", aplicarFiltros);
    aplicarFiltros();
  }

  function aplicarFiltros() {
    const idSel = document.getElementById("filtroID").value;
    const actSel = document.getElementById("filtroAct").value;
    const filtrados = rawData.filter(r => {
      const idOk = (idSel === "todos") || (r.ID_BD === idSel);
      const actOk = (actSel === "todas") || (r.Actividad === actSel);
      return idOk && actOk;
    });
    const tasks = filtrados.map(r => ({
      name: r.ID_BD + "-" + r.Actividad,
      start: r.Inicio,
      end: r.Fin,
      progress: r.Progreso ? parseInt(r.Progreso, 10) : 0
    }));
    dibujarGantt(tasks);
  }

  function dibujarGantt(tasks) {
    const rowHeight = 40;
    const barHeight = 20;
    const monthWidth = 120;

    const toDate = s => new Date(s + "T00:00:00");
    const fmt = d => d.toISOString().slice(0, 10);
    const monthsBetween = (d1,d2) => (d2.getFullYear()-d1.getFullYear())*12 + (d2.getMonth()-d1.getMonth());

    // rango elegido en selects
    const yearStart = parseInt(document.getElementById("yearStart").value, 10);
    const yearEnd   = parseInt(document.getElementById("yearEnd").value, 10);

    const startDate = new Date(yearStart, 0, 1);
    const endDate   = new Date(yearEnd, 11, 31);

    const totalMonths = monthsBetween(startDate, endDate) + 1;
    const svgWidth = totalMonths * monthWidth;

    // Escala
    const scaleEl = document.getElementById("scale");
    scaleEl.innerHTML = "";
    let current = new Date(startDate);
    while (current <= endDate) {
      const diff = monthsBetween(startDate, current);
      const x = diff * monthWidth;

      const tick = document.createElement("div");
      tick.className = "tick";
      tick.style.left = x + "px";
      scaleEl.appendChild(tick);

      const lab = document.createElement("div");
      lab.className = "label";
      lab.style.left = (x + monthWidth/2) + "px";
      lab.textContent = current.toLocaleString("es", { month:"short", year:"numeric" });
      scaleEl.appendChild(lab);

      current.setMonth(current.getMonth() + 1);
    }

    // Cuerpo
    const body = document.getElementById("body");
    body.innerHTML = "";

    const svgNS = "http://www.w3.org/2000/svg";
    const tt = document.getElementById("tooltip");
    const showTip = (evt, html) => {
      tt.innerHTML = html;
      tt.style.opacity = "1";
      const pad = 12;
      tt.style.left = (evt.clientX + pad) + "px";
      tt.style.top  = (evt.clientY + pad) + "px";
    };
    const hideTip = () => tt.style.opacity = "0";

    tasks.forEach((t) => {
      const row = document.createElement("div");
      row.className = "row";

      const left = document.createElement("div");
      left.className = "left";
      const name = document.createElement("div"); name.textContent = t.name;
      const badge = document.createElement("span"); badge.className = "badge"; badge.textContent = `${t.progress}%`;
      left.appendChild(name); left.appendChild(badge);

      const right = document.createElement("div");
      right.className = "right"; right.style.height = rowHeight + "px";

      const svg = document.createElementNS(svgNS, "svg");
      svg.setAttribute("width", svgWidth);
      svg.setAttribute("height", rowHeight);

      const startM = monthsBetween(startDate, toDate(t.start));
      const endM   = monthsBetween(startDate, toDate(t.end));
      const x = startM * monthWidth;
      const w = (endM - startM + 1) * monthWidth;
      const y = (rowHeight - barHeight) / 2;

      const rect = document.createElementNS(svgNS, "rect");
      rect.setAttribute("x", x); rect.setAttribute("y", y);
      rect.setAttribute("width", w); rect.setAttribute("height", barHeight);
      rect.setAttribute("fill", "var(--bar)");

      const rectProg = document.createElementNS(svgNS, "rect");
      rectProg.setAttribute("x", x); rectProg.setAttribute("y", y);
      rectProg.setAttribute("width", w * (t.progress/100));
      rectProg.setAttribute("height", barHeight);
      rectProg.setAttribute("fill", "var(--barDone)");

      svg.appendChild(rect);
      svg.appendChild(rectProg);

      svg.addEventListener("mousemove", e => {
        showTip(e, `<strong>${t.name}</strong><br>${fmt(toDate(t.start))} â†’ ${fmt(toDate(t.end))}<br>Progreso: ${t.progress}%`);
      });
      svg.addEventListener("mouseleave", hideTip);

      right.appendChild(svg);

      row.appendChild(left);
      row.appendChild(right);
      body.appendChild(row);
    });

    // ðŸ”¹ LÃ­nea de hoy en todo el body
    const hoy = new Date();
    const gantt = document.getElementById("gantt");
    let todayLine = document.querySelector(".today-line");
    if (todayLine) todayLine.remove();
    if (hoy >= startDate && hoy <= endDate) {
      const diff = monthsBetween(startDate, hoy);
      const x = diff * monthWidth + (hoy.getDate() / new Date(hoy.getFullYear(), hoy.getMonth()+1, 0).getDate()) * monthWidth;
      todayLine = document.createElement("div");
      todayLine.className = "today-line";
      todayLine.style.left = (240 + x) + "px"; // compensar columna izquierda
      gantt.appendChild(todayLine);
    }
  }
})();
</script>
</body>
</html>
